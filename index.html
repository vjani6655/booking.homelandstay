<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Stay - Homeland Stay</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="customer-page">
    <div class="customer-header">
        <h1>Homeland Stay</h1>
        <p>Book Your Perfect Stay</p>
    </div>

    <div class="booking-form-container">
        <div class="booking-card">
            <h2>Booking Request</h2>
            <p class="info-text">Fill in the details below and we'll get back to you shortly via email, phone, or WhatsApp.</p>
            
            <form id="bookingForm">
                <div class="form-group">
                    <label for="name">Name *</label>
                    <input type="text" id="name" required>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number *</label>
                    <input type="tel" id="phone" placeholder="+91 98765 43210 or +1 (555) 123-4567" required>
                    <small>Indian or international phone number</small>
                </div>

                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" required>
                    <small>Booking confirmation will be sent to this email</small>
                </div>

                <div class="form-group">
                    <label for="state">State and City</label>
                    <input type="text" id="state" placeholder="e.g., Maharashtra, Mumbai">
                    <small>Which state and city are you from?</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="checkIn">Check-in Date *</label>
                        <input type="date" id="checkIn" required>
                    </div>

                    <div class="form-group">
                        <label for="checkOut">Check-out Date *</label>
                        <input type="date" id="checkOut" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="adults">Number of Adults *</label>
                        <input type="number" id="adults" min="1" value="1" required>
                    </div>

                    <div class="form-group">
                        <label for="kids">Number of Kids (under 12) *</label>
                        <input type="number" id="kids" min="0" value="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>ID Proof (Upload at least one document)</label>
                    <div class="upload-group">
                        <div class="upload-item">
                            <label for="aadhar" class="upload-label">
                                <span>üìÑ Aadhar Card</span>
                            </label>
                            <input type="file" id="aadhar" class="file-input" accept="image/*">
                            <div class="file-preview" id="aadharPreview"></div>
                        </div>

                        <div class="upload-item">
                            <label for="pan" class="upload-label">
                                <span>üìÑ PAN Card</span>
                            </label>
                            <input type="file" id="pan" class="file-input" accept="image/*">
                            <div class="file-preview" id="panPreview"></div>
                        </div>

                        <div class="upload-item">
                            <label for="passport" class="upload-label">
                                <span>üìÑ Passport</span>
                            </label>
                            <input type="file" id="passport" class="file-input" accept="image/*">
                            <div class="file-preview" id="passportPreview"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="message">Message (Optional)</label>
                    <textarea id="message" rows="4" placeholder="Any special requests or questions?"></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Send Booking Request</button>
                
                <div id="formMessage" class="hidden" style="margin-top: 1rem;"></div>
            </form>
        </div>
    </div>

    <script>
        let csrfToken = '';
        
        // Fetch CSRF token on page load
        async function fetchCSRFToken() {
            try {
                const response = await fetch('api/csrf.php');
                const data = await response.json();
                if (data.success) {
                    csrfToken = data.csrf_token;
                }
            } catch (error) {
                console.error('Failed to fetch CSRF token:', error);
            }
        }
        
        fetchCSRFToken();
        
        // Set minimum dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('checkIn').min = today;
        document.getElementById('checkOut').min = today;

        // Update checkout min date when checkin changes
        document.getElementById('checkIn').addEventListener('change', (e) => {
            const checkIn = e.target.value;
            document.getElementById('checkOut').min = checkIn;
            
            // Validate date range
            const checkOutValue = document.getElementById('checkOut').value;
            if (checkOutValue && checkOutValue <= checkIn) {
                document.getElementById('checkOut').value = '';
            }
        });

        // File upload preview handlers
        function setupFilePreview(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB');
                        input.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.innerHTML = `<img src="${e.target.result}" style="max-width: 150px; border-radius: 8px;">`;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        setupFilePreview('aadhar', 'aadharPreview');
        setupFilePreview('pan', 'panPreview');
        setupFilePreview('passport', 'passportPreview');

        // Form submission
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const messageDiv = document.getElementById('formMessage');
            
            // Show loading state
            submitButton.disabled = true;
            submitButton.textContent = 'Sending...';
            messageDiv.textContent = 'Sending your request...';
            messageDiv.className = 'text-secondary';
            messageDiv.classList.remove('hidden');
            
            // Validate dates
            const checkIn = document.getElementById('checkIn').value;
            const checkOut = document.getElementById('checkOut').value;
            
            if (new Date(checkOut) <= new Date(checkIn)) {
                messageDiv.textContent = '‚ùå Check-out date must be after check-in date';
                messageDiv.className = 'text-danger';
                submitButton.disabled = false;
                submitButton.textContent = 'Send Booking Request';
                return;
            }
            
            const bookingData = {
                customer_name: document.getElementById('name').value,
                customer_phone: document.getElementById('phone').value,
                customer_email: document.getElementById('email').value,
                customer_state: document.getElementById('state').value,
                check_in_date: checkIn,
                check_out_date: checkOut,
                num_adults: parseInt(document.getElementById('adults').value),
                num_kids: parseInt(document.getElementById('kids').value),
                message: document.getElementById('message').value,
                csrf_token: csrfToken
            };
            
            try {
                const response = await fetch('api/public_booking.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageDiv.textContent = `‚úÖ ${data.message} Reference: ${data.booking_reference}`;
                    messageDiv.className = 'text-success';
                    document.getElementById('bookingForm').reset();
                    document.querySelectorAll('.file-preview').forEach(p => p.style.display = 'none');
                    
                    // Refresh CSRF token
                    fetchCSRFToken();
                } else {
                    messageDiv.textContent = '‚ùå ' + (data.message || 'An error occurred. Please try again.');
                    messageDiv.className = 'text-danger';
                }
            } catch (error) {
                messageDiv.textContent = '‚ùå Connection error. Please check your internet and try again.';
                messageDiv.className = 'text-danger';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Send Booking Request';
            }
        });
    </script>
</body>
</html>
